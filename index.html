<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Gerador Pixel‑art ➜ printf()</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#121212;
      --card:#1e1e1e;
      --accent:#2563eb;
      --accent-hover:#1e4fbb;
      --text:#e5e5e5;
      --border:#333;
    }
    *{box-sizing:border-box}
    body{font-family:System-ui, sans-serif; margin:0; padding:2rem; background:var(--bg); color:var(--text);}
    h1{font-size:1.8rem; margin-bottom:1rem}
    .card{background:var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow:0 4px 10px rgba(0,0,0,.4); padding:1.5rem; margin-bottom:2rem}
    label{display:block; margin:.5rem 0; font-weight:600}
    input[type="file"]{margin-top:.3rem}
    textarea{width:100%; min-height:280px; font-family:monospace; font-size:.9rem; padding:1rem; border-radius:.5rem; border:1px solid var(--border); background:#000; color:var(--text)}
    .btn{display:inline-block; margin-top:1rem; background:var(--accent); color:#fff; padding:.6rem 1.2rem; border-radius:.75rem; cursor:pointer; border:none; font-size:.9rem; transition:.15s}
    .btn:hover{background:var(--accent-hover)}
    canvas{display:none}
    .preview{font-family:"Cascadia Mono",Consolas,"Courier New",monospace;font-size:12px;line-height:1;display:inline-block;background:#000;color:#fff;border-radius:.5rem;white-space:pre;overflow:hidden;padding:0;}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <h1>Gerador Pixel‑art ➜ <code>printf()</code></h1>

  <div class="card">
    <label>Envie um PNG 78 × 44 (com transparência):
      <input id="imgInput" type="file" accept="image/png" />
    </label>

    <label>
      <input type="radio" name="mode" value="fg" checked /> Foreground (<code>38;2</code> + "██")
    </label>
    <label>
      <input type="radio" name="mode" value="bg" /> Background (<code>48;2</code> + espaços)
    </label>

    <button id="genBtn" class="btn">Gerar código C</button>
    <button id="copyBtn" class="btn">Copiar código</button>
  </div>

  <div class="card">
    <label>Pré‑visualização:</label>
    <pre id="ansiPreview" class="preview"></pre>
  </div>

  <div class="card">
    <label>Código gerado:</label>
    <textarea id="codeOut" readonly></textarea>
  </div>

  <canvas id="cvs" width="78" height="44"></canvas>

<script>
const ESC="\\e["; // usa \e[ em vez de \x1b[
const imgInput=document.getElementById('imgInput');
const genBtn=document.getElementById('genBtn');
const copyBtn=document.getElementById('copyBtn');
const codeOut=document.getElementById('codeOut');
const preview=document.getElementById('ansiPreview');
const cvs=document.getElementById('cvs');
const ctx=cvs.getContext('2d');

const rgbTuple=(d,i)=>[d[i],d[i+1],d[i+2]];
const sameColor=(a,b)=>a&&b&&a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2];

function gerarCodigo(usaBg,nomeFunc){
  const modo=usaBg?"48":"38";
  const pixel=usaBg?"  ":"██";
  const img=ctx.getImageData(0,0,78,44).data;
  let corAtual=null;
  const linhas=[`void ${nomeFunc}() {`]; // sem #include
  for(let y=0;y<44;y++){
    let col=0;
    let buf=['    printf("'];
    for(let x=0;x<78;x++){
      const idx=(y*78+x)*4;
      if(img[idx+3]===0) continue;
      const dest=x*2;
      const mov=dest-col;
      if(mov){buf.push(`${ESC}${mov}C`); col=dest;}
      const rgb=rgbTuple(img,idx);
      if(!sameColor(rgb,corAtual)){
        buf.push(`${ESC}${modo};2;${rgb[0]};${rgb[1]};${rgb[2]}m`);
        corAtual=rgb;
      }
      buf.push(pixel);
      col+=2;
    }
    buf.push(`${ESC}E");`);
    linhas.push(buf.join(""));
  }
  linhas.push(`    printf("${ESC}0m");`,`}`);
  return linhas.join("\n");
}

function gerarPreview(usaBg){
  const img=ctx.getImageData(0,0,78,44).data;
  let html='';
  for(let y=0;y<44;y++){
    for(let x=0;x<78;x++){
      const idx=(y*78+x)*4;
      if(img[idx+3]===0){html+='&nbsp;&nbsp;';continue;}
      const [r,g,b]=rgbTuple(img,idx);
      html+=usaBg?`<span style=\"background:rgb(${r},${g},${b});\">&nbsp;&nbsp;</span>`:`<span style=\"color:rgb(${r},${g},${b});\">██</span>`;
    }
    html+='<br/>';
  }
  return html;
}

function handleGenerate(){
  const arquivo=imgInput.files[0];
  if(!arquivo){alert('Selecione uma imagem PNG antes');return;}
  const base=arquivo.name.replace(/^(.*[\\/])?/,'').replace(/\.[^.]+$/,'');
  const nomeFunc=`desenhar_${base}`.replace(/[^a-zA-Z0-9_]/g,'_');
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      ctx.clearRect(0,0,78,44);
      ctx.drawImage(img,0,0,78,44);
      const usaBg=document.querySelector('input[name="mode"]:checked').value==='bg';
      codeOut.value=gerarCodigo(usaBg,nomeFunc);
      preview.innerHTML=gerarPreview(usaBg);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(arquivo);
}

function handleCopy(){
  if(!codeOut.value){alert('Nada para copiar ainda!');return;}
  navigator.clipboard.writeText(codeOut.value).then(()=>{
    copyBtn.textContent='Copiado ✔';
    setTimeout(()=>copyBtn.textContent='Copiar código',1500);
  });
}

genBtn.addEventListener('click',handleGenerate);
copyBtn.addEventListener('click',handleCopy);
</script>
</body>
</html>
